---
title: Репликация
---

Репликация &mdash; это процесс синхронизации состояния нескольких узлов распределенной системы. Под репликацией (например, в СУБД) обычно понимают копирование данных с одного узла на один или несколько других. Однако проблема, которую решают CRDT, заключается в том, что разные клиенты работают с одним и тем же состоянием, распределенным по нескольким узлам. В один и тот же момент разные клиенты могут изменять состояние разных узлов, но после синхронизации все они должны прийти в одно и то же состояние. В данном контексте репликацию следует рассматривать именно как процесс синхронизации.

Выделяют несколько классификаций репликации.

Одна из них выделяет *пессимистичную* и *оптимистичную* репликацию. При *пессимистичной репликации* каждый узел считает, что существует единственная копия состояния (на данной узле), не обращая внимания на клиентские запросы к другим узлам, работающим с этим состоянием (репликам). Для поддержки консистентного состояния необходимо постоянно синхронизировать все реплики. Такая модель может быть слишком медленной для узлов в глобальной сети. Однако в локальных сетях задержки относительно небольшие, что может быть приемлемо.

*Оптимистичная репликация* предполагает осознанное принятие факта расхождения состояний узлов. Это означает, что клиенты могут читать и изменять разные значения состояния одного и того же объекта, если они работают с разными репликами. Безусловно, разработчик веб-приложения должен знать об этой особенности и принимать архитектурные решения, учитывая это. Такой вариант репликации позволяет сделать приложение более отказоустойчивым из-за отсутствия координирования узлов друг с другом.

При использовании CRDT допустимо использовать и оптимистичную, и пессимистичную репликацию, поскольку в конечном счете состояние всех реплик будет одинаковым.

Другая классификация выделяет *активную* и *пассивную* репликацию. При *активной (или синхронной) репликации* во время обновления все узлы связаны единой транзакцией. Такой механизм репликации использует соединение каждого узла с каждым, а все узлы имеют одинаковые возможности и доступны всем клиентам. Хотя возможно использовать и архитектуру с единым координирующим узлом (*master*), но это понижает устойчивость системы к разделению.

При *пассивной (асинхронной) репликации* синхронизация состояния происходит вне транзакции. То есть каждый узел изменяет свое состояние, а после изменения инициирует синхронизацию. В случае возникновения недопустимых или неоднозначных состояний система может перестать работать, чтобы не допустить неправильного состояния, до тех пор, пока оно не будет вручную исправлено. Таким образом данный вид репликации снижает или доступность, или консистентность системы.

Преимуществом при работе с CRDT является возможность использования пассивной репликации, хотя и применение активной репликации допустимо.

Еще одна классификация разделяет процессы репликации на *основанные на передаче операций* и *основанные на передаче состояния*. При *передаче состояния* данные обновления включают в себя полное состояние объекта (в оптимизированных алгоритмах минимально необходимую часть состояния). В случае *передачи операций* передаются изменения, которые должны быть применены на всех узлах. Размер состояния часто больше, чем размер описания одной операции, что влияет на количество передаваемых между узлами данных. Небольшой размер передаваемых данных является преимуществом репликации, основанной на передаче операций. В то же время операции должны быть гарантировано коммутативные, чтобы их можно было применять в любом порядке. В случае, если это невозможно, применяется передача состояния.

Существуют варианты CRDT, реализующие оба способа передачи.